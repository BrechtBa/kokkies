
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">


<link rel="import" href="shared-styles.html">
<link rel="import" href="object-list-behavior.html">

<link rel="import" href="period-productgroup.html">

<dom-module id="view-period-detail-productgroups">

    <template>

        <style include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: block;
                position: relative;
            }
            @media screen and (min-width: 560px) {
                :host {
                    padding: 10px;
                }
            }
            .productgroup{
                background-color: #ffffff;
            }
            .buttons{
                margin-bottom: 8px;
            }
            paper-input.search{
                margin-bottom: 8px;
            }
        </style>


        <app-route route="{{route}}" pattern="/:key" data="{{routeData}}" tail="{{subroute}}"></app-route>


        <iron-pages role="sub" selected="[[page]]" attr-for-selected="name">

            <div name="list">
                <div class="buttons horizontal layout">
                    <paper-button raised on-tap="newItem">New productgroup</paper-button>
                </div>

                <paper-input class="search" label="search" no-label-float value="{{productgroupSearch}}"><iron-icon icon="search" suffix></iron-icon></paper-input>

                <template is="dom-repeat" items="{{_toArray(productgroups)}}" as="productgroup" filter="{{_searchFilter(productgroupSearch)}}" sort="_sortByName" observe="val.name">
                    <paper-material class="productgroup horizontal layout center wrap">
                        <div class="name flex">{{productgroup.val.name}}</div>
                        <paper-icon-button icon="create" raised on-tap="editItem">Edit</paper-icon-button>
                    </paper-material>
                </template>
            </div>

            <div name="detail">

                <period-productgroup user="{{user}}" productgroup="{{tempItem}}" products="{{products}}"></period-productgroup>

                <div class="buttons">
                    <paper-button raised on-tap="saveItem">Save</paper-button>
                    <paper-button raised on-tap="deleteItemDialog">Delete</paper-button>
                </div>

            </div>

        </iron-pages>


        <paper-dialog id="deleteItemDialog">
            <h2>Are you sure?</h2>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm on-tap="deleteItem">Delete</paper-button>
            </div>
        </paper-dialog>

    </template>

    <script>
        Polymer({
            is: 'view-period-detail-productgroups',

            behaviors: [
                objectListBehavior,
                searchFilterBehavior,
            ],

            properties:{
                user: {
                    type: Object,
                },
                period: {
                    type: String,
                },
                productgroups: {
                    type: Object,
                    notify: true,
                },
                products: {
                    type: Object,
                    notify: true,
                },
                route: {
                    type: 'string',
                    notify: true,
                }
            },

            observers: [
                '_routeDataChanged(routeData.*,productgroups)',
            ],

            newItem: function(){
                this.set('route.path','/new');
            },
            
            editItem: function(e){
                e.stopPropagation();
                var key = e.model.__data__.productgroup.key;
                this.set('route.path','/'+key);
            },

            saveItem: function(e){
                e.stopPropagation();

                this.set('productgroups.'+this.routeData.key,JSON.parse(JSON.stringify(this.tempItem)));
                this.back();
            },

            deleteItemDialog: function(e){
                e.stopPropagation();
                this.$.deleteItemDialog.open();
            },

            deleteItem: function(e){
                e.stopPropagation();

                this.set('productgroups.'+this.routeData.key,null);
                this.back();
            },

            back: function(e){
                if(typeof this.page == 'undefined' || this.page == '' || this.page == 'list'){
                    return false;
                }
                else{

                    var route = JSON.parse(JSON.stringify(this.route));

                    route.path = ''
                    this.set('route.path','');
                    this.set('routeData',{});
                    return true;

                }
            },

            _routeDataChanged: function(change,productgroups){

                var key = this.routeData.key

                if(typeof key!='undefined' && key!=''){
                    if(key=='new' ){
                        var key = btoa(this.user.uid + Date.now());
                        this.set('tempItem',{'name':'','products':{}})
                    }
                    else if(typeof productgroups[key]!='undefined'){
                        this.set('tempItem',JSON.parse(JSON.stringify(productgroups[key])));
                    }
                    this.set('route.path','/'+key);
                    this.set('page', 'detail');
                }
                else{
                    this.set('page', 'list');
                }
            },

            _sortByName: function(a,b){
                var a_order = this._getObjectProperty(this.productgroups,a.key,'name');
                var b_order = this._getObjectProperty(this.productgroups,b.key,'name');
                if(a_order>b_order){
                    return 1;
                }
                else if(a_order<b_order){
                    return -1;
                }
                else{
                    return 0;
                }
            },
        });
    </script>

</dom-module>
