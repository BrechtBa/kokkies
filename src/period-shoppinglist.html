<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="shoppinglist-product.html">

<dom-module id="period-shoppinglist">

    <template>

        <style include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: block;
            }
            .shoppinglist{
                background-color: #ffffff;
            }
        </style>
        

        <firebase-document app-name="kokkies" path="/[[user.uid]]/shoppinglists/[[period]]/[[key]]" data="{{shoppinglist}}"></firebase-document>


        <paper-material class="shoppinglist vertical layout">
            <div class="horizontal layout center">
                <div class="collapse btn" on-tap="_toggleCollapse"><iron-icon icon="expand-more"></iron-icon></div>
                <div class="name"><paper-input label="Naam" value="{{shoppinglist.name}}"></div>
                <div class="flex">&nbsp;</div>
                <div class="date"><paper-input label="Datum" value="{{shoppinglist.date}}"></div>
            </div>

            <iron-collapse>
                <div class="content vertical layout">

                    <template is="dom-repeat" items="{{_toArray(shoppinglistproducts)}}" as="product" sort="{{_sortByName(products)}}">

                        <shoppinglist-product user="[[user]]" period="[[period]]" shoppinglist="{{key}}" key="{{product.key}}" quantity="{{product.val.quantity}}" products="{{products}}"></shoppinglist-product>

                    </template>
                </div>
            </iron-collapse>

        </paper-material>


    </template>

    <script>

        Polymer({

            is: 'period-shoppinglist',

            behaviors: [
                objectListBehavior,
                searchFilterBehavior,
                collapsibleBehavior,
            ],

            properties:{
                user: {
                    type: Object
                },
                period: {
                    type: String,
                },
                key: {
                    type: String,
                },
                dayproductgroups: {
                    type: Object,
                },
                dayproductgroupproducts: {
                    type: Object,
                },
                products: {
                    type: Object,
                    notify: true,
                },
                productgroups: {
                    type: Object,
                    notify: true,
                },
            },

            observers: [
                '_calculateShoppinglist(key,dayproductgroups,dayproductgroupproducts,productgroups,products)'
            ],

            _calculateShoppinglist: function(key,dayproductgroups,dayproductgroupproducts,productgroups,products){
                
                var oldshoppinglistproducts = {}
                if(typeof shoppinglistproducts != 'undefined'){
                    oldshoppinglistproducts = JSON.parse(JSON.stringify(this.shoppinglistproducts));
                }


                // calculate the new quantities
                var shoppinglistproducts = {};

                for(day in dayproductgroups){
                    for(meal in dayproductgroups[day]){

                        for(productgroup in dayproductgroups[day][meal]){
                            var productgroupquantity = dayproductgroups[day][meal][productgroup].quantity

                            if(typeof dayproductgroupproducts[day] != 'undefined' && typeof dayproductgroupproducts[day][meal] != 'undefined'){

                                for(product in dayproductgroupproducts[day][meal][productgroup]){
                                    if(dayproductgroupproducts[day][meal][productgroup][product].shoppinglist == key){

                                        if(typeof shoppinglistproducts[product] == 'undefined'){
                                            shoppinglistproducts[product] = {'quantity':0}
                                        }
                                        shoppinglistproducts[product].quantity += productgroupquantity*productgroups[productgroup].products[product].quantity
                                    }

                                }
                            }
                        }
                    }
                }

                // set the checked attributes
                for(product in shoppinglistproducts){
                    if(product in oldshoppinglistproducts){
                        if(shoppinglistproducts[product].quantity == oldshoppinglistproducts[product].quantity){
                            shoppinglistproducts[product].checked = oldshoppinglistproducts[product].checked;
                        }
                        else{
                            shoppinglistproducts[product].checked = false;
                        }
                    }
                    else{
                        shoppinglistproducts[product].checked = false;
                    }
                }

                // bind and notify changes
                this.set('shoppinglistproducts',shoppinglistproducts);

            },


            _sortByName: function(products){
                return function(a,b){
                    if(products[a.key].name > products[b.key].name){
                        return 1;
                    }
                    else if(products[a.key].name < products[b.key].name){
                        return -1;
                    }
                    else{
                        return 0;
                    }
                };

            },

            shoppinglistHtml: function(){
                var html = '';

                html+= '                <h1>'+this.shoppinglist.name+'</h1>';

                var date = this.shoppinglist.date;
                html+= '                <div class="date">';
                if(typeof date != 'undefined'){
                    html+= date;
                }
                html+= '</div>\n';

                var products = Polymer.dom(this.root).querySelectorAll('shoppinglist-product');

                for(var i=0; i<products.length; i++){
                    html += '               <div class="product">\n';
                    html+= products[i].shoppinglistHtml();

                    html += '               </div>\n';
                }

                return html;
            },

        });

    </script>

</dom-module>
