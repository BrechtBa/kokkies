
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="object-list-behavior.html">
<link rel="import" href="search-filter-behavior.html">
<link rel="import" href="collapsible-behavior.html">

<link rel="import" href="day-productgroup.html">

<dom-module id="period-productgroup">

    <template>

        <style include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: block;
                background-color: #ffffff;
            }
            paper-input{
                margin-top: -8px;
                margin-bottom: -8px;
            }
            .add{
                float: right;
                top: -20px;
                right: 20px;
                background-color: #cccccc;
            }
            .cicle-button{
                width: 50px;
                min-width: 0;
                height: 50px;
                border-radius: 25px;
            }
            .product{
                background-color: #ffffff;
            }
            .product .name{
                min-width: 200px;
            }
            .product .quantity{
                width: 60px;
                text-align: right;
                margin-right: 5px;
            }
            .product .unit{
                min-width: 40px;
                margin-right: 10px;
            }
            .comment{
                width: 50%;
                min-width: 200px;
            }
        </style>

        <!--<firebase-document app-name="kokkies" path="/[[user.uid]]/productgroups/[[period]]/[[key]]" data="{{productgroup}}" disabled="{{!opened}}"></firebase-document>-->

        <paper-material>

            <div class="horizontal layout">
                <paper-input label="Name" value="{{productgroup.name}}"></paper-input>
            </div>

            <template is="dom-repeat" items="{{_toArray(productgroup.products)}}" as="product">


                <paper-material class="product horizontal layout center">
                    <div class="name">{{_getObjectProperty(products,product.key,'name')}}</div>
                    <div class="quantity"><paper-input label="Quantity" value="{{product.val.quantity}}" no-label-float="true" on-change="_handleProductQuantityChange"></paper-input></div>
                    <div class="unit">{{_getObjectProperty(products,product.key,'unit')}}</div>
                    <template is="dom-if" if="{{_hasSecondunit(products,product.key)}}">
                        <div class="quantity">~ [[_getSecondQuantity(products,product.key,product.val.quantity)]]</div>
                        <div class="unit">{{_getObjectProperty(products,product.key,'secondunit')}}</div>
                    </template>
                    <div class="flex">&nbsp;</div>
                    <paper-icon-button icon="delete" raised on-tap="deleteProduct">Delete</paper-icon-button>
                </paper-material>

            </template>

            <template is="dom-if" if="{{!_isEmpty(productgroup.products)}}">
                <paper-button raised class="add cicle-button" on-tap="addProductDialog"><iron-icon icon="add"></iron-icon></paper-button>
            </template>

            <template is="dom-if" if="{{_isEmpty(productgroup.products)}}">
                <paper-button raised class="add" on-tap="addProductDialog">Add product</paper-button>
            </template>

            <paper-input class="comment" label="Opmerking" value="{{productgroup.comment}}"></paper-input>

        </paper-material>

        <paper-dialog id="addProductDialog">
            <paper-button class="close" dialog-dismiss>close</paper-button>
            <paper-dialog-scrollable>
                <h3>Product toevoegen</h3>
                <paper-input label="search" no-label-float value="{{productSearch}}"><iron-icon icon="search" suffix></iron-icon></paper-input>
                <template is="dom-repeat" items="{{_toArray(products)}}" as="product" filter="{{_searchFilter(productSearch)}}" observe="name">
                    <paper-material class="product btn horizontal layout wrap" on-tap="addProduct">
                        <div class="name">{{product.val.name}}</div>
                    </paper-material>
                </template>

            <paper-button raised on-tap="newProductDialog">Nieuw</paper-button>
            </paper-dialog-scrollable>
        </paper-dialog>

        <paper-dialog id="newProductDialog">
            <h3>Nieuw product</h3>
            <paper-input label="Naam" value="{{productSearch}}"></paper-input>
            <paper-input label="Unit" value="{{newProductUnit}}"></paper-input>
                <paper-input label="Second unit" value="{{newProductSecondunit}}"></paper-input>
                <paper-input label="Unit conversion, ( 1 [[newProductUnit]] = [[newProductUnitconversion]] [[newProductSecondunit]] )" value="{{newProductUnitconversion}}"></paper-input>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm on-tap="newProduct">Save</paper-button>
            </div>
        </paper-dialog>



    </template>

    <script>

        Polymer({
            is: 'period-productgroup',

            behaviors: [
                objectListBehavior,
                searchFilterBehavior,
            ],

            properties:{
                user: {
                    type: Object,
                },
                productgroup: {
                    type: Object,
                    value: {},
                    notify: true,
                },
                products: {
                    type: Object,
                    notify: true,
                },
            },

            ready: function(){
                this.newItemKey = 'temp';
            },

            addProductDialog: function(e){
                this.$.addProductDialog.open();
            },
            
            addProduct: function(e){
                this.$.addProductDialog.close();

                var key = e.model.__data__.product.key;
                if(typeof this.productgroup.products == 'undefined'){
                    this.productgroup.products = {}
                }
                if(typeof this.productgroup.products[key] == 'undefined'){
                    // add the key
                    var order = 0;
                    for(k in this.productgroup.products){
                        order = Math.max(this.productgroup.products[k]['order']+1,order)
                    }
                    this.productgroup.products[key] = {'quantity':0,'order':order};
                }
                this.set('productgroup', JSON.parse(JSON.stringify(this.productgroup)));
            },

            deleteProduct: function(e){

                var key = e.model.__data__.product.key;

                this.productgroup.products[key] = null;

                // check if there are products left
                var empty = true;
                for(key in this.productgroup.products){
                    if(this.productgroup.products[key] != null){
                        empty = false;
                        break;
                    }
                }
                if(empty){
                    this.productgroup.products = {};
                }

                this.set('productgroup', JSON.parse(JSON.stringify(this.productgroup)));
            },

            newProductDialog: function(e){
                this.$.newProductDialog.open()
            },

            newProduct: function(e){
                var newItemKey = btoa(this.user.uid + Date.now());
                var newItem = {
                    'name':this.productSearch,
                    'unit':this.newProductUnit,
                    'secondunit':this.newProductSecondunit,
                    'unitconversion':this.newProductUnitconversion,
                    'packagequantity':1,
                    'price':0,
                    'store':'',
                };
                this.set('products.'+newItemKey,newItem);
                this.set('newProductUnit','');
                this.set('newProductSecondunit','');
                this.set('newProductUnitconversion',1);

                // add the product
                var e = {
                    'model':{
                        '__data__':{
                            'product':{
                                'key': newItemKey
                            }
                        }
                    }
                }
                this.addProduct(e)
            },

            _handleProductQuantityChange :function(e){
                var key = e.model.__data__.product.key;
                this.set('productgroup.products.'+key,JSON.parse(JSON.stringify(this.productgroup.products[key])));
            },

            _hasSecondunit: function(products,key){
                return this._getObjectProperty(products,key,'secondunit') != '';
            },

            _getSecondQuantity: function(products,key,quantity){
                return this._round( quantity*this._getObjectProperty(products,key,'unitconversion') );
            },

            _round: function(val){
                var decimals = 0;
                if(val < 20){
                    decimals = 1;
                }
                if(val < 1){
                    decimals = 2;
                }
                return val.toFixed(decimals);
            },

        });

    </script>

</dom-module>



