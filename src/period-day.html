
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="object-list-behavior.html">
<link rel="import" href="search-filter-behavior.html">
<link rel="import" href="collapsible-behavior.html">

<link rel="import" href="day-productgroup.html">

<dom-module id="period-day">

    <template>

        <style include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: block;
                background-color: #ffffff;
            }
            paper-input{
                margin-top: -8px;
                margin-bottom: -8px;
            }
            .day{
                margin-top: 5px;
                margin-bottom: 5px;
                font-size: 1.17em;
                font-weight: bold;
            }
            .weekday{
                width: 100px;
            }
            .collapse{
                width: 40px;
                margin-right: 4px;
                margin-top: 8px;
            }
            .edit-uncollapsed{
                position: absolute;
                top: 10px;
                right: 10px;
            }
        </style>

        <firebase-document app-name="kokkies" path="/[[user.uid]]/days/[[period]]/[[key]]" data="{{day}}"></firebase-document>



        <paper-material class="vertical layout">
            <div class="horizontal layout">
                <div class="collapse btn" on-tap="_toggleCollapse"><iron-icon icon="expand-more"></iron-icon></div>
                <div class="day flex">Dag [[number]]</div>
                <div class="weekday">[[date.weekday]]</div>
                <div class="date flex">[[date.date]]</div>
            </div>

            <iron-collapse>
                <div class="content">

                    <sortable-js id="sortable" group="dayProductgroups" handle=".drag-handle" on-update="_handleSortable" on-add="_handleSortable" on-remove="_handleSortable">
                        <template is="dom-repeat" items="{{sortableArray}}" as="productgroup">
                            <day-productgroup user="[[user]]" period="[[period]]" day="[[key]]" key="[[productgroup.key]]" products="{{products}}" productgroups="{{productgroups}}" shoppinglists="{{shoppinglists}}" on-delete="deleteProductgroup" on-move-up="moveUpProductgroup" on-move-down="moveDownProductgroup"></day-productgroup>
                        </template>
                    </sortable-js>

                    <paper-button raised on-tap="addProductgroupDialog">Gerecht toevoegen</paper-button>

                    <div class="edit-uncollapsed">
                        <paper-icon-button icon="arrow-upward" on-tap="_moveUp"></paper-icon-button>
                        <paper-icon-button icon="arrow-downward" on-tap="_moveDown"></paper-icon-button>
                        <paper-icon-button icon="delete" on-tap="deleteDayDialog"></paper-icon-button>
                    </div>
                </div>
            </iron-collapse>

        </paper-material>

        <paper-dialog id="addProductgroupDialog">
            <paper-button class="close" dialog-dismiss>close</paper-button>
            <paper-dialog-scrollable>
                <h3>Gerecht toevoegen</h3>
                <paper-input label="search" no-label-float value="{{productgroupSearch}}"><iron-icon icon="search" suffix></iron-icon></paper-input>
                <template is="dom-repeat" items="{{_toArray(productgroups)}}" as="productgroup" filter="{{_searchFilter(productgroupSearch)}}" observe="name">
                    <paper-material class="productgroup btn horizontal layout wrap" on-tap="addProductgroup">
                        <div class="name">{{productgroup.val.name}}</div>
                    </paper-material>
                </template>
            </paper-dialog-scrollable>
        </paper-dialog>


        <paper-dialog id="deleteDayDialog">
            <h2>Are you sure?</h2>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm on-tap="deleteDay">Delete</paper-button>
            </div>
        </paper-dialog>


    </template>

    <script>

        Polymer({
            is: 'period-day',

            behaviors: [
                objectListBehavior,
                searchFilterBehavior,
                collapsibleBehavior,
            ],

            properties:{
                user: {
                    type: Object
                },
                period: {
                    type: String,
                },
                key: {
                    type: String,
                },
                number: {
                    type: Number,
                },
                date: {
                    type: String,
                },
                products: {
                    type: Object,
                    notify: true,
                },
                productgroups: {
                    type: Object,
                    notify: true,
                },
                shoppinglists: {
                    type: Object,
                },
            },

            observers: [
                '_updateSortableArray(day.productgroups)'
            ],

            addProductgroupDialog: function(e){
                this.$.addProductgroupDialog.open();
            },
            
            addProductgroup: function(e){
                this.$.addProductgroupDialog.close();

                var key = e.model.__data__.productgroup.key;
                if(typeof this.day.productgroups == 'undefined'){
                    this.set('day.productgroups',{})
                }
                if(typeof this.day.productgroups[key] == 'undefined'){
                    // add the key
                    this.set('day.productgroups.'+key,Object.keys(this.day.productgroups).length+1);
                }
            },

            deleteDayDialog: function(e){
                e.stopPropagation();
                this.$.deleteDayDialog.open();
            },

            deleteDay: function(e){

                // propagate down
                var elements = Polymer.dom(this.root).querySelectorAll('day-productgroup');
                for(var i=0;i<elements.length;i++){
                    elements[i].deleteProductgroup()
                }

                this.set('day',null);

                // propagate up
                this.fire('delete',this.key)
            },

            deleteProductgroup: function(e,d){
                this.set('day.productgroups.'+d,null);
                
                // reset numbers
                var object = this.day.productgroups;
                var array = []
                for( key in object){
                    if( object[key] != null ){
                        array.push([key,object[key]])
                    }
                }
                array.sort(function(a, b) {
                    return a[1] - b[1];
                });

                for(var i=0;i<array.length;i++){
                    this.set('day.productgroups.'+array[i][0],i+1)
                }

                //this.calculateProducts();
            },



            _updateSortableArray: function(val){
                //console.log(val)
                if(typeof val != 'undefined'){
                    
                    if(typeof this.sortableArray == 'undefined'){
                        this.sortableArray = this._toArraySortByVal(val);
                    }
                    else if(Object.keys(val).length > Object.keys(this.sortableArray).length){
                        // push the last element
                        var sorted = this._toArraySortByVal(val)
                        this.push('sortableArray',sorted[sorted.length-1])
                    }
                    else if(Object.keys(val).length < Object.keys(this.sortableArray).length){

                        for(var i=0;i<this.sortableArray.length;i++){
                            if( !(this.sortableArray[i].key in val) ){
                                this.splice('sortableArray',i,1)
                                break;
                            }
                        }
                    }
                }
            },

            _handleSortable: function(e){

                console.log('_handleSortable')
                console.log(e)
                console.log(e.type)
                console.log(this.sortableArray)

                if(e.type == 'sort'){
                    var order = {}
                    for(var i=0;i<this.sortableArray.length;i++){
                        order[this.sortableArray[i].key] = i+1;
                    }
                    for(key in order){
                        //this.day.productgroups[key] = order[key];
                        this.set( 'day.productgroups.'+key, order[key] )
                    }

                    this.notifyPath('day.productgroups')
                }
                else if(e.type == 'add'){
                    for(var i=0;i<this.sortableArray.length;i++){
                        if(!(this.sortableArray[i].key in this.day.productgroups)){
                            //console.log(this.sortableArray[i])
                            //this.set( 'day.productgroups.'+this.sortableArray[i].key, this.sortableArray[i].val );
                            break;
                        }
                    }
                }
                else if(e.type == 'remove'){
                    for(key in this.day.productgroups){
                        var remove = true;
                        for(var i=0;i<this.sortableArray.length;i++){
                            if( this.sortableArray[i].key == key ){
                                remove = false;
                                break;
                            }
                        }
                        if(remove){
                            console.log('day.productgroups.'+key)
                            //this.set( 'day.productgroups.'+key, null );
                            break;
                        }
                    }
                }
            },

            moveUpProductgroup: function(e,d){
                var object = this.day.productgroups;
                var val = object[d];

                if(val!=1){
                    for(key in object){
                        if(object[key] == val-1){
                            this.set('day.productgroups.'+key,val);
                        }
                    }
                    this.set('day.productgroups.'+d,val-1);
                }
            },

            moveDownProductgroup: function(e,d){
                var object = this.day.productgroups;
                var val = object[d];

                if(val!=Object.keys(object).length){
                    for( key in object){
                        if(object[key] == val+1){
                            this.set('day.productgroups.'+key,val);
                        }
                    }
                    this.set('day.productgroups.'+d,val+1);
                }
            },

            _moveUp: function(){
                this.fire('move-up',this.key)
            },

            _moveDown: function(){
                this.fire('move-down',this.key)
            },
        });

    </script>

</dom-module>



