
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="object-list-behavior.html">
<link rel="import" href="search-filter-behavior.html">
<link rel="import" href="collapsible-behavior.html">

<link rel="import" href="period-day.html">
<link rel="import" href="day-meal.html">

<dom-module id="view-period-detail-planning">

    <template>

        <style include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: block;
                position: relative;
                padding: 10px;
            }
            .add{
                float: right;
                top: -20px;
                right: 20px;
                background-color: #cccccc;
            }
            .cicle-button{
                width: 50px;
                min-width: 0;
                height: 50px;
                border-radius: 25px;
            }
            .spacer{
                margin-top: 50px;
            }
            .print{
                position: absolute;
                top: -50px;
                right: 10px;
                background-color: #cccccc;
            }
            .day{
                margin-top: 5px;
                margin-bottom: 5px;
                font-size: 1.17em;
                font-weight: bold;
            }
            .collapse{
                width: 40px;
                margin-right: 4px;
                margin-top: 8px;
            }
            paper-material{
                background-color: #ffffff;
            }

        </style>

        <paper-button class="print" raised on-tap="print">Print</paper-button>

        <template is="dom-repeat" items="{{_toArray(days)}}" as="day" sort=_sortByVal>

            <period-day user="[[user]]" meals="[[meals]]" period="[[period]]" key="[[day.key]]" number="[[day.val]]" date="[[_computeDayDate(periodStartdate,day.val)]]" products="{{products}}" productgroups="{{productgroups}}" shoppinglists="{{shoppinglists}}" on-delete="deleteDay" on-move-up="moveUpDay" on-move-down="moveDownDay"></period-day>

        </template>
        
        <template is="dom-if" if="{{!_isEmpty(days)}}">
            <paper-button raised class="add cicle-button" on-tap="addDay"><iron-icon icon="add"></iron-icon></paper-button>
        </template>

        <template is="dom-if" if="{{_isEmpty(days)}}">
            <paper-button raised class="add" on-tap="addDay">Dag toevoegen</paper-button>
        </template>

        <div class="spacer"></div>

        <paper-material class="vertical layout">
            <div class="horizontal layout">
                <div class="collapse btn" on-tap="_toggleCollapse"><iron-icon icon="expand-more"></iron-icon></div>
                <div class="day flex">Algemeen</div>
            </div>

            <iron-collapse>
                <div class="content">
                    <day-meal user="[[user]]" period="[[period]]" day="other" key="Algemeen" products="{{products}}" productgroups="{{productgroups}}" shoppinglists="{{shoppinglists}}"></day-meal>
                </div>
            </iron-collapse>

        </paper-material>


    </template>

    <script>

        Polymer({
            is: 'view-period-detail-planning',

            behaviors: [
                objectListBehavior,
                searchFilterBehavior,
                collapsibleBehavior,
            ],

            properties:{
                user: {
                    type: Object,
                },
                period: {
                    type: String
                },
                periodStartdate: {
                    type: String
                },
                days: {
                    type: Object,
                    notify: true,
                },
                perioddays: {
                    type: Object,
                    notify: true,
                },
                products: {
                    type: Object,
                },
                productgroups: {
                    type: Object,
                },
                shoppinglists: {
                    type: Object,
                },
            },

            ready: function(){
                this.meals = ['Ontbijt', 'Middag', '4-uurtje', 'Avond', '11-uurtje']
            },

            addDay: function(e){
                var key = btoa(this.user.uid + Date.now());

                if(typeof this.days == 'undefined'){
                    this.set('days',{});
                }
                this.set('days.'+key,Object.keys(this.days).length+1);
            },
            
            deleteDay: function(e,d){
                this.set('days.'+d,null);
                
                // reset numbers
                var object = this.period.days;
                var array = []
                for( key in object){
                    if( object[key] != null ){
                        array.push([key,object[key]])
                    }
                }
                array.sort(function(a, b) {
                    return a[1] - b[1];
                });

                for(var i=0;i<array.length;i++){
                    this.set('days.'+array[i][0],i+1)
                }
            },

            _computeDayDate: function(startdate,number){
                var parts = startdate.split("-");
                d = new Date(parts[2], parts[1] - 1, parts[0])
                d.setDate(d.getDate() + number-1)
                
                var day = ['Zondag', 'Maandag', 'Dinsdag', 'Woensdag','Donderdag', 'Vrijdag', 'Zaterdag'];

                var dayindex = d.getDay();
                var date = d.getDate();
                var month = d.getMonth()+1;
                var year = d.getFullYear();

                return {'weekday':day[dayindex], 'date': date + '-' + month + '-' + year};
            },

            moveUpDay: function(e,d){
                var object = this.period.days;
                var val = object[d];

                if(val!=1){
                    for(key in object){
                        if(object[key] == val-1){
                            this.set('period.days.'+key,val);
                        }
                    }
                    this.set('period.days.'+d,val-1);
                }
            },

            moveDownDay: function(e,d){
                var object = this.period.days;
                var val = object[d];

                if(val!=Object.keys(object).length){
                    for( key in object){
                        if(object[key] == val+1){
                            this.set('period.days.'+key,val);
                        }
                    }
                    this.set('period.days.'+d,val+1);
                }
            },

            _round: function(val){
                var decimals = 0;
                if(val < 20){
                    decimals = 1;
                }
                if(val < 1){
                    decimals = 2;
                }
                return val.toFixed(decimals);
            },

            planningHtml: function(){

                var html = '';

                var days = Polymer.dom(this.root).querySelectorAll('period-day');

                // split in two groups of 5 days
                if( days.length > 5 ){
                    var daygroups = [days.slice(0,5),days.slice(5)]
                }
                else{
                    var daygroups = [days]
                }

                for(var k=0; k<daygroups.length; k++){
                    html += '        <div class="page planning">\n';
                    html += '            <h1>Planning</h1>\n';
                    html += '            <div class="table">\n';
                    html += '                <div class="column header">\n';
                    html += '                    <div class="cell header"></div>\n';
                    html += '                    <div class="cell subheader"></div>\n';

                    for(var i=0; i<this.meals.length; i++){
                        var meal = this.meals[i];
                        html += '                    <div class="cell">'+this.meals[i]+'</div>\n';
                    }

                    html += '                </div>\n';

                    for(var j=0; j<daygroups[k].length; j++){
                        var day = daygroups[k][j]

                        html += '                <div class="column">\n';
                        html += day.planningHtml();
                        html += '                </div>\n';

                    }
                    html += '            </div>\n';
                    html += '        </div>\n';
                }

                return html
            },

            detailHtml: function(){
                var html = '';

                var days = Polymer.dom(this.root).querySelectorAll('period-day');

                for(var i=0; i<days.length; i++){
                    html += '        <div class="page detail">\n';

                    html += '            <div class="day">\n';
                    html+= days[i].detailHtml();
                    html += '            </div>\n';

                    html += '        </div>\n';
                }

                return html;
            },

            print: function(){

                var html = '';
                html += '<html>\n';
                html += '    <head>\n';
                html += '        <style type="text/css">\n';
                html += '            body {\n';
                html += '                font-family: sans-serif;\n';
                html += '            }\n';
                html += '            div.page {\n';
                html += '                width: 1100px;\n';
                html += '                min-height: 730px;\n';
                html += '                page-break-inside: avoid;\n';
                html += '            }\n';
                html += '            div.table {\n';
                html += '                width: 1100px;\n';
                html += '                height: 650px;\n';
                html += '            }\n';
                html += '            div.table div.column {\n';
                html += '                float: left;\n';
                html += '                width: 200px;\n';
                html += '            }\n';
                html += '            div.table div.column div.cell {\n';
                html += '                position: relative;\n';
                html += '                border: 1px solid;\n';
                html += '                height: 105px;\n';
                html += '                padding: 2px;\n';
                html += '            }\n';
                html += '            div.table div.column.header {\n';
                html += '                width: 100px;\n';
                html += '                background-color: #dddddd;\n';
                html += '            }\n';
                html += '            div.table div.column div.cell.header {\n';
                html += '                height: 60px;\n';
                html += '                background-color: #dddddd;\n';
                html += '            }\n';
                html += '            div.table div.column div.cell.subheader {\n';
                html += '                height: 40px;\n';
                html += '            }\n';
                html += '            span.weekday {\n';
                html += '                margin-right: 3px;\n';
                html += '            }\n';
                html += '            span.date {\n';
                html += '                margin-left: 3px;\n';
                html += '            }\n';
                html += '            .planning div.productgroup {\n';
                html += '                position: relative;\n';
                html += '                text-align: left;\n';
                html += '            }\n';
                html += '            .planning div.productgroup div.name {\n';
                html += '                margin-right: 10px;\n';
                html += '            }\n';
                html += '            .planning div.comment {\n';
                html += '                position: absolute;\n';
                html += '                right: 1px;\n';
                html += '                bottom: 1px;\n';
                html += '                color: #555555;\n';
                html += '                font-size: 0.8em;\n';
                html += '            }\n';
                html += '            .planning div.quantity {\n';
                html += '                position: absolute;\n';
                html += '                top: 5px;\n';
                html += '                right: 0px;\n';
                html += '                color: #222222;\n';
                html += '                font-size: 0.9em;\n';
                html += '                text-align: right;\n';
                html += '            }\n';

                html += '            .detail .meal {\n';
                html += '                page-break-inside: avoid;\n';
                html += '            }\n';
                html += '            .detail .productgroup {\n';
                html += '                margin-top: 10px;\n';
                html += '            }\n';
                html += '            .detail .productgroup .product {\n';
                html += '                border-bottom: 1px solid;\n';
                html += '            }\n';
                html += '            .detail .productgroup .name {\n';
                html += '                display: inline-block;\n';
                html += '                min-width: 400px;\n';
                html += '                font-weight: 700;\n';
                html += '            }\n';
                html += '            .detail .productgroup .quantity {\n';
                html += '                display: inline-block;\n';
                html += '                font-weight: 700;\n';
                html += '            }\n';
                html += '            .detail .productgroup .product span {\n';
                html += '                font-weight: 300;\n';
                html += '            }\n';
                html += '            .detail .productgroup .product span.name {\n';
                html += '                display: inline-block;\n';
                html += '                width: 300px;\n';
                html += '                min-width: 300px;\n';
                html += '            }\n';
                html += '            .detail .productgroup .product span.quantity {\n';
                html += '                display: inline-block;\n';
                html += '                width: 50px;\n';
                html += '                text-align: right;\n';
                html += '            }\n';
                html += '            .detail .productgroup .product span.unit {\n';
                html += '                display: inline-block;\n';
                html += '                width: 50px;\n';
                html += '            }\n';
                html += '            .detail .productgroup .product span.shoppinglist {\n';
                html += '                display: inline-block;\n';
                html += '                width: 300px;\n';
                html += '            }\n';
                html += '            .detail .productgroup .product span.used {\n';
                html += '                display: inline-block;\n';
                html += '                width: 300px;\n';
                html += '            }\n';

                html += '        </style>\n';
                html += '        <style type="text/css" media="print">\n';
                html += '            @page {\n';
                html += '                size: landscape;\n';
                html += '            }\n';
                html += '        </style>\n';
                html += '    </head>\n';

                html += '    <body>\n';

                html += this.planningHtml();

                html += this.detailHtml();

                html += '    </body>\n'
                html += '</html>\n'

                // put the html in a new window and print
                var newWindow = window.open("about:blank", "", "_blank");
                newWindow.document.write(html);
                newWindow.print()
            },

        });

    </script>

</dom-module>
