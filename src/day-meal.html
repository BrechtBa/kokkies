
<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="object-list-behavior.html">
<link rel="import" href="search-filter-behavior.html">
<link rel="import" href="collapsible-behavior.html">

<link rel="import" href="day-productgroup.html">

<dom-module id="day-meal">

    <template>

        <style include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: block;
                background-color: #ffffff;
            }
            paper-input{
                margin-top: -8px;
                margin-bottom: -8px;
            }
            h1{
                font-size: 1em;
                margin-top: 20px;
                margin-bottom: 0;
            }

            .add{
                float: right;
                top: -20px;
                right: 20px;
                background-color: #cccccc;
            }
            .cicle-button{
                width: 50px;
                min-width: 0;
                height: 50px;
                border-radius: 25px;
            }
            .collapse{
                width: 40px;
                margin-right: 4px;
                margin-top: 8px;
            }
            .comment{
                width: 50%;
                min-width: 200px;
            }
            .edit-uncollapsed{
                position: absolute;
                top: 10px;
                right: 10px;
            }
        </style>

        <firebase-document app-name="kokkies" path="/[[user.uid]]/days/[[period]]/[[day]]/[[key]]" data="{{meal}}"></firebase-document>

        <h1>[[key]]</h1>

        <sortable-js id="sortable" group="dayProductgroups" handle=".drag-handle" on-update="_handleSortable" on-add="_handleSortable" on-remove="_handleSortable">
            <template is="dom-repeat" items="{{sortableArray}}" as="productgroup">
                <day-productgroup user="[[user]]" period="[[period]]" day="[[day]]" meal="[[key]]" key="[[productgroup.key]]" products="{{products}}" productgroups="{{productgroups}}" shoppinglists="{{shoppinglists}}" on-delete="deleteProductgroup" on-move-up="moveUpProductgroup" on-move-down="moveDownProductgroup"></day-productgroup>
            </template>
        </sortable-js>

        <template is="dom-if" if="{{!_isEmpty(meal.productgroups)}}">
            <paper-button raised class="add cicle-button" on-tap="addProductgroupDialog"><iron-icon icon="add"></iron-icon></paper-button>
        </template>

        <template is="dom-if" if="{{_isEmpty(meal.productgroups)}}">
            <paper-button raised class="add" on-tap="addProductgroupDialog">Gerecht toevoegen</iron-icon></paper-button>
        </template>

        <paper-input class="comment" label="Opmerkingen" value="{{meal.comment}}"></paper-input>

        <paper-dialog id="addProductgroupDialog">
            <paper-button class="close" dialog-dismiss>close</paper-button>
            <paper-dialog-scrollable>
                <h3>Gerecht toevoegen</h3>
                <paper-input label="search" no-label-float value="{{productgroupSearch}}"><iron-icon icon="search" suffix></iron-icon></paper-input>
                <template is="dom-repeat" items="{{_toArray(productgroups)}}" as="productgroup" filter="{{_searchFilter(productgroupSearch)}}" observe="name">
                    <paper-material class="productgroup btn horizontal layout wrap" on-tap="addProductgroup">
                        <div class="name">{{productgroup.val.name}}</div>
                    </paper-material>
                </template>
            </paper-dialog-scrollable>
        </paper-dialog>

    </template>

    <script>

        Polymer({
            is: 'day-meal',

            behaviors: [
                objectListBehavior,
                searchFilterBehavior,
                collapsibleBehavior,
            ],

            properties:{
                user: {
                    type: Object
                },
                period: {
                    type: String,
                },
                day: {
                    type: String,
                },
                key: {
                    type: String,
                },
                number: {
                    type: Number,
                },
                date: {
                    type: String,
                },
                products: {
                    type: Object,
                    notify: true,
                },
                productgroups: {
                    type: Object,
                    notify: true,
                },
                shoppinglists: {
                    type: Object,
                },
            },

            observers: [
                '_updateSortableArray(meal.productgroups)'
            ],

            ready: function(){
                this.meals = ['Ontbijt', 'Middag', '4-uurtje', 'Avond', '11-uurtje']
            },

            addProductgroupDialog: function(e){
                this.$.addProductgroupDialog.open();
            },
            
            addProductgroup: function(e){
                this.$.addProductgroupDialog.close();

                var key = e.model.__data__.productgroup.key;
                if(typeof this.meal.productgroups == 'undefined'){
                    this.set('meal.productgroups',{})
                }
                if(typeof this.meal.productgroups[key] == 'undefined'){
                    // add the key
                    this.set('meal.productgroups.'+key,Object.keys(this.meal.productgroups).length+1);
                }
            },

            deleteProductgroup: function(e,d){
                this.set('meal.productgroups.'+d,null);
                
                // reset numbers
                var object = this.meal.productgroups;
                var array = []
                for( key in object){
                    if( object[key] != null ){
                        array.push([key,object[key]])
                    }
                }
                array.sort(function(a, b) {
                    return a[1] - b[1];
                });

                for(var i=0;i<array.length;i++){
                    this.set('meal.productgroups.'+array[i][0],i+1)
                }

                //this.calculateProducts();
            },



            _updateSortableArray: function(val){
                //console.log(val)
                if(typeof val != 'undefined'){
                    
                    if(typeof this.sortableArray == 'undefined'){
                        this.sortableArray = this._toArraySortByVal(val);
                    }
                    else if(Object.keys(val).length > Object.keys(this.sortableArray).length){
                        // push the last element
                        var sorted = this._toArraySortByVal(val)
                        this.push('sortableArray',sorted[sorted.length-1])
                    }
                    else if(Object.keys(val).length < Object.keys(this.sortableArray).length){

                        for(var i=0;i<this.sortableArray.length;i++){
                            if( !(this.sortableArray[i].key in val) ){
                                this.splice('sortableArray',i,1)
                                break;
                            }
                        }
                    }
                }
            },

            _handleSortable: function(e){

                console.log('_handleSortable')
                console.log(e)
                console.log(e.type)
                console.log(this.sortableArray)

                if(e.type == 'sort'){
                    var order = {}
                    for(var i=0;i<this.sortableArray.length;i++){
                        order[this.sortableArray[i].key] = i+1;
                    }
                    for(key in order){
                        //this.meal.productgroups[key] = order[key];
                        this.set( 'meal.productgroups.'+key, order[key] )
                    }

                    this.notifyPath('meal.productgroups')
                }
                else if(e.type == 'add'){
                    for(var i=0;i<this.sortableArray.length;i++){
                        if(!(this.sortableArray[i].key in this.meal.productgroups)){
                            //console.log(this.sortableArray[i])
                            //this.set( 'meal.productgroups.'+this.sortableArray[i].key, this.sortableArray[i].val );
                            break;
                        }
                    }
                }
                else if(e.type == 'remove'){
                    for(key in this.meal.productgroups){
                        var remove = true;
                        for(var i=0;i<this.sortableArray.length;i++){
                            if( this.sortableArray[i].key == key ){
                                remove = false;
                                break;
                            }
                        }
                        if(remove){
                            console.log('meal.productgroups.'+key)
                            //this.set( 'meal.productgroups.'+key, null );
                            break;
                        }
                    }
                }
            },

            _isEmpty: function(obj){
                if(typeof obj == 'object'){
                    return Object.keys(obj).length == 0;
                }
                else{
                    return true;
                }
            },

            _isNotEmpty: function(obj){
                if(typeof obj == 'object'){
                    return Object.keys(obj).length == 0;
                }
                else{
                    return false;
                }
            },

            moveUpProductgroup: function(e,d){
                var object = this.meal.productgroups;
                var val = object[d];

                if(val!=1){
                    for(key in object){
                        if(object[key] == val-1){
                            this.set('meal.productgroups.'+key,val);
                        }
                    }
                    this.set('meal.productgroups.'+d,val-1);
                }
            },

            moveDownProductgroup: function(e,d){
                var object = this.meal.productgroups;
                var val = object[d];

                if(val!=Object.keys(object).length){
                    for( key in object){
                        if(object[key] == val+1){
                            this.set('meal.productgroups.'+key,val);
                        }
                    }
                    this.set('meal.productgroups.'+d,val+1);
                }
            },

            planningHtml: function(){

                var html = '';

                if(typeof this.meal != 'undefined' && typeof this.meal.productgroups != 'undefined'){
                    for( productgroup in this.meal.productgroups){
                        html += '<div class="productgroup">'+this.productgroups[productgroup].name+'</div>';
                    }
                }

                if(typeof this.meal != 'undefined' && typeof this.meal.comment != 'undefined'){
                    html += '<div class="comment">'+this.meal.comment+'</div>';
                }

                return html;
            },

        });

    </script>

</dom-module>



