
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bower_components/polymer-sortablejs/polymer-sortablejs.html"/>

<link rel="import" href="shared-styles.html">
<link rel="import" href="object-list-behavior.html">
<link rel="import" href="search-filter-behavior.html">
<link rel="import" href="collapsible-behavior.html">

<link rel="import" href="day-productgroup-product.html">

<dom-module id="day-productgroup">

    <template>

        <style include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: block;
                background-color: #f7f7f7;
            }
            paper-input{
                margin-top: -8px;
                margin-bottom: -8px;
            }
            .collapse{
                width: 40px;
                margin-right: 4px;
                margin-top: 0px;
            }
            .name{
                min-width: 200px;
            }
            .quantity{
                width: 80px;
            }
            .product-list{
                margin-left: 60px;
            }
            .edit-uncollapsed{
                position: absolute;
                top: 10px;
                right: 10px;
            }
        </style>

        <firebase-document app-name="kokkies" path="/[[user.uid]]/dayproductgroups/[[period]]/[[day]]/[[key]]" data="{{productgroup}}"></firebase-document>

        <paper-material class="vertical layout">
            
            <div class="horizontal layout center">
                <div class="collapse btn drag-handle" on-tap="_toggleCollapse"><iron-icon icon="editor:drag-handle"></iron-icon></div>
                <div class="collapse btn" on-tap="_toggleCollapse"><iron-icon icon="expand-more"></iron-icon></div>
                <div class="name">[[_getObjectProperty(productgroups,key,'name')]]</div>
                <div class="quantity"><paper-input label="Aantal" value="{{productgroup.quantity}}"></paper-input></div>
            </div>

            <iron-collapse>
                <div class="content product-list">

                    <template is="dom-repeat" items="{{_getProducts(key,productgroups)}}" as="product">

                        <day-productgroup-product user="[[user]]" period="[[period]]" day="[[day]]" productgroup="[[key]]" key="[[product.key]]" products="{{products}}" productgroups="{{productgroups}}" quantity="{{productgroup.quantity}}" shoppinglists="{{shoppinglists}}"></day-productgroup-product>

                    </template>

                </div>
                <div class="edit-uncollapsed">
                    <paper-icon-button icon="arrow-upward" on-tap="_moveUp"></paper-icon-button>
                    <paper-icon-button icon="arrow-downward" on-tap="_moveDown"></paper-icon-button>
                    <paper-icon-button icon="delete" on-tap="deleteProductgroupDialog"></paper-icon-button>
                </div>
            </iron-collapse>

        </paper-material>

        <paper-dialog id="deleteProductgroupDialog">
            <h2>Are you sure?</h2>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm on-tap="deleteProductgroup">Delete</paper-button>
            </div>
        </paper-dialog>

    </template>

    <script>

        Polymer({
            is: 'day-productgroup',

            behaviors: [
                objectListBehavior,
                collapsibleBehavior,
            ],

            properties:{
                user: {
                    type: 'Object'
                },
                period: {
                    type: String,
                },
                day: {
                    type: String
                },
                key: {
                    type: String
                },
                products: {
                    type: Object,
                    notify: true,
                },
                productgroups: {
                    type: Object,
                    notify: true,
                },
                shoppinglists: {
                    type: Object,
                },
            },

            _getProducts: function(key,productgroups){
                return this._toArray(this._getObjectProperty(productgroups,key,'products'));
            },

            deleteProductgroupDialog: function(e){
                e.stopPropagation();
                this.$.deleteProductgroupDialog.open();
            },

            deleteProductgroup: function(e){

                // propagate down
                var elements = Polymer.dom(this.root).querySelectorAll('day-productgroup-product');
                for(var i=0;i<elements.length;i++){
                    elements[i].deleteProductgroupProduct()
                }

                this.set('productgroup',null);

                //propagate up
                this.fire('delete',this.key)
            },

            _moveUp: function(){
                this.fire('move-up',this.key)
            },

            _moveDown: function(){
                this.fire('move-down',this.key)
            },
        });

    </script>

</dom-module>



