
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer-sortablejs/polymer-sortablejs.html">

<link rel="import" href="object-list-behavior.html">

<link rel="import" href="day-productgroup.html">

<dom-module id="stored-object-sortable">

    <template>

        <style>
            :host {
                display: block;
            }
        </style>


        <sortable-js id="sortable" group="[[group]]" handle=".drag-handle" on-update="_handleSortable">
            <content></content>
            <template id="repeater" is="dom-repeat" items="{{itemsArray}}" as="item">
                <day-productgroup user="[[user]]" day="[[key]]" key="[[productgroup.key]]" products="{{products}}" productgroups="{{productgroups}}" on-delete="deleteProductgroup" on-move-up="moveUpProductgroup" on-move-down="moveDownProductgroup"></day-productgroup>
            </template>
        </sortable-js>


    </template>

    <script>

        Polymer({
            is: 'stored-object-sortable',

            behaviors: [
                objectListBehavior,
                searchFilterBehavior,
                collapsibleBehavior,
            ],

            properties:{
                group: {
                    type: String
                },
                items: {
                    type: Object,
                },
                number: {
                    type: Number,
                },
                date: {
                    type: String,
                },
                products: {
                    type: Object,
                    notify: true,
                },
                productgroups: {
                    type: Object,
                    notify: true,
                },
            },
            observers: [
                '_createProductgroupsArray(day.productgroups)'
            ],

            _createProductgroupsArray: function(val){
                
                if(typeof val != 'undefined'){
                    
                    if(typeof this.dayProductgroupsArray == 'undefined'){
                        this.dayProductgroupsArray = this._toArraySortByVal(val);
                    }
                    else if(Object.keys(val).length > Object.keys(this.dayProductgroupsArray).length){
                        // push the last element
                        var sorted = this._toArraySortByVal(val)
                        this.push('dayProductgroupsArray',sorted[sorted.length-1])
                    }
                    else if(Object.keys(val).length < Object.keys(this.dayProductgroupsArray).length){
                        console.log('element removed')
                        console.log(val);
                        console.log(this.dayProductgroupsArray);
                        for(var i=0;i<this.dayProductgroupsArray.length;i++){
                            if( !(this.dayProductgroupsArray[i].key in val) ){
                                this.splice('dayProductgroupsArray',i,1)
                            }
                        }
                    }
                }
            },

            addProductgroupDialog: function(e){
                this.$.addProductgroupDialog.open();
            },
            
            addProductgroup: function(e){
                this.$.addProductgroupDialog.close();

                var key = e.model.__data__.productgroup.key;
                if(typeof this.day.productgroups == 'undefined'){
                    this.set('day.productgroups',{})
                }
                if(typeof this.day.productgroups[key] == 'undefined'){
                    // add the key
                    this.set('day.productgroups.'+key,Object.keys(this.day.productgroups).length+1);
                }
            },

            deleteDayDialog: function(e){
                e.stopPropagation();
                this.$.deleteDayDialog.open();
            },

            deleteDay: function(e){

                // propagate down
                var elements = Polymer.dom(this.root).querySelectorAll('day-productgroup');
                for(var i=0;i<elements.length;i++){
                    elements[i].deleteProductgroup()
                }

                this.set('day',null);

                // propagate up
                this.fire('delete',this.key)
            },

            deleteProductgroup: function(e,d){
                this.set('day.productgroups.'+d,null);
                
                // reset numbers
                var object = this.day.productgroups;
                var array = []
                for( key in object){
                    if( object[key] != null ){
                        array.push([key,object[key]])
                    }
                }
                array.sort(function(a, b) {
                    return a[1] - b[1];
                });

                for(var i=0;i<array.length;i++){
                    this.set('day.productgroups.'+array[i][0],i+1)
                }

                //this.calculateProducts();
            },

            _sortedDayProductGroups: function(day){
                return this._toArraySortByVal(day.productgroups)
            },

            _handleSortable: function(e){

                console.log('_handleSortable')
                console.log(this.dayProductgroupsArray)

                var order = {}
                for(var i=0;i<this.dayProductgroupsArray.length;i++){
                    order[this.dayProductgroupsArray[i].key] = i+1;
                    
                }
                for(key in order){
                    //this.day.productgroups[key] = order[key];
                    this.set( 'day.productgroups.'+key, order[key] )
                }

                this.notifyPath('day.productgroups')

            },

            moveUpProductgroup: function(e,d){
                var object = this.day.productgroups;
                var val = object[d];

                if(val!=1){
                    for(key in object){
                        if(object[key] == val-1){
                            this.set('day.productgroups.'+key,val);
                        }
                    }
                    this.set('day.productgroups.'+d,val-1);
                }
            },

            moveDownProductgroup: function(e,d){
                var object = this.day.productgroups;
                var val = object[d];

                if(val!=Object.keys(object).length){
                    for( key in object){
                        if(object[key] == val+1){
                            this.set('day.productgroups.'+key,val);
                        }
                    }
                    this.set('day.productgroups.'+d,val+1);
                }
            },

            _moveUp: function(){
                this.fire('move-up',this.key)
            },

            _moveDown: function(){
                this.fire('move-down',this.key)
            },
        });

    </script>

</dom-module>



